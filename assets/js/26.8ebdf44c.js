(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{510:function(t,s,a){"use strict";a.r(s);var e=a(20),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("帮助一位同学解决手动实现traceroute遇到了Windows socket使用setsockopt设置TTL无效的问题，原因很离奇，在这里记录一下。")]),t._v(" "),a("h2",{attrs:{id:"起因"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#起因"}},[t._v("#")]),t._v(" 起因")]),t._v(" "),a("p",[t._v("同学需要手动实现traceroute，即自己组ICMP数据包，发送出去，手动解析接受到的数据。")]),t._v(" "),a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("p",[t._v("每次都只能拿到一个回复，然后直接结束，wireshark抓包发现无论ttl设置为多少，实际发送的ttl都为0x80，这就解释了为什么只收到了一个回复，因为已经到目标地址了。")]),t._v(" "),a("h2",{attrs:{id:"解决过程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决过程"}},[t._v("#")]),t._v(" 解决过程")]),t._v(" "),a("p",[t._v("设置ttl使用如下代码：")]),t._v(" "),a("div",{staticClass:"language-cpp line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-cpp"}},[a("code",[t._v("result "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setsockopt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("sock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IPPROTO_IP"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" IP_TTL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("char")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("ttl"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sizeof")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("无论ttl是多少，使用getsockopt获取到的ttl都是1，且实际发送的为0x80，且全称没有任何函数返回值非0。(即没有函数报错)。该代码使用Dev C++编写，编译器为"),a("code",[t._v("TDM-GCC 4.9.2")]),t._v("。将代码复制到Visual Studio编译，运行成功，符合预期，怀疑是编译器问题，进一步找到是链接器选项问题。")]),t._v(" "),a("h2",{attrs:{id:"解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解决方案"}},[t._v("#")]),t._v(" 解决方案")]),t._v(" "),a("p",[t._v("将Dev c++链接器参数从"),a("code",[t._v("-lwsock32")]),t._v("改为"),a("code",[t._v("-lws2_32")]),t._v("，即可成功解决。")])])}),[],!1,null,null,null);s.default=r.exports}}]);